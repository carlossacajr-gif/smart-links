---
import Layout from '../layouts/Layout.astro';
import DashboardApp from '../components/DashboardApp';

// Protegido por el middleware. Si llegamos aquí, tenemos sesión válida en supabase.
const { cookies } = Astro;
const accessToken = cookies.get("sb-access-token")?.value;
const refreshToken = cookies.get("sb-refresh-token")?.value;

// Asegurarse de tener la sesión para el render inicial inyectada
import { supabase } from '../lib/supabase';
await supabase.auth.setSession({
  access_token: accessToken || '',
  refresh_token: refreshToken || ''
});

const { data: { user } } = await supabase.auth.getUser();

// Obtener links iniciales por SSR para hidratar React
const { data: initialLinks } = await supabase
  .from('links')
  .select('*, clicks(count)')
  .order('created_at', { ascending: false });

---

<Layout title="Dashboard">
  <main className="min-h-screen p-4 md:p-[5vh] max-w-[1400px] mx-auto flex flex-col gap-10">
    <header className="glass-panel rounded-3xl p-6 md:px-8 relative overflow-hidden group flex justify-between items-center transition-all duration-700 hover:border-indigo-500/30 hover:shadow-[0_0_80px_rgba(99,102,241,0.1)]">
      
      <!-- Fondo dinámico interno -->
      <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-indigo-500/10 blur-[120px] rounded-full pointer-events-none group-hover:bg-indigo-500/20 transition-all duration-1000"></div>
      
      <div className="flex items-center gap-5 relative z-10">
        <div className="w-14 h-14 rounded-2xl bg-indigo-500/10 border border-indigo-500/20 flex flex-col justify-center items-center backdrop-blur-md relative">
          <!-- Anillo exterior animado -->
          <div className="absolute inset-[-2px] rounded-[18px] border border-indigo-400/30 animate-[spin_4s_linear_infinite] opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
          
          <div className="w-3 h-3 rounded-full bg-indigo-500 animate-pulse shadow-[0_0_15px_rgba(99,102,241,0.8)]"></div>
        </div>
        <div>
          <h1 className="text-3xl font-display font-semibold tracking-[-0.03em] text-white m-0 leading-tight">Smart Links</h1>
          <p className="text-sm font-medium text-zinc-400 m-0 mt-1 opacity-80">{user?.email}</p>
        </div>
      </div>
      
      <button 
        id="logout-btn" 
        class="text-sm px-5 py-2.5 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 text-zinc-200 transition-all duration-300 relative z-10 font-medium tracking-wide active:scale-95"
      >
        Sign Out
      </button>
    </header>

    <DashboardApp client:only="react" initialLinks={initialLinks || []} />
  </main>
</Layout>

<script>
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    // Feedback táctil visual antes de salir
    document.getElementById('logout-btn')!.style.opacity = '0.5';
    
    await fetch('/api/auth/set-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ event: 'SIGNED_OUT', session: null }),
    });
    window.location.href = '/login';
  });
</script>
