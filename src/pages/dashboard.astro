---
import Layout from '../layouts/Layout.astro';
import DashboardApp from '../components/DashboardApp';

// Protegido por el middleware. Si llegamos aquí, tenemos sesión válida en supabase.
const { cookies } = Astro;
const accessToken = cookies.get("sb-access-token")?.value;
const refreshToken = cookies.get("sb-refresh-token")?.value;

// Asegurarse de tener la sesión para el render inicial inyectada
import { supabase } from '../lib/supabase';
await supabase.auth.setSession({
  access_token: accessToken || '',
  refresh_token: refreshToken || ''
});

const { data: { user } } = await supabase.auth.getUser();

// Obtener links iniciales por SSR para hidratar React
const { data: initialLinks } = await supabase
  .from('links')
  .select('*, clicks(count)')
  .order('created_at', { ascending: false });

---

<Layout title="Dashboard">
  <main class="min-h-screen p-4 sm:p-8 xl:p-12 max-w-[1400px] mx-auto flex flex-col gap-8 xl:gap-12">
    <header class="glass-panel rounded-[2rem] p-6 lg:py-5 lg:px-8 relative overflow-hidden group flex flex-col sm:flex-row justify-between items-center sm:items-center gap-6 sm:gap-0 transition-all duration-700 hover:border-[#EB3333]/20 hover:shadow-[0_0_80px_rgba(235,51,51,0.03)] dark:hover:shadow-[0_0_80px_rgba(235,51,51,0.08)]">
      
      <!-- Fondo dinámico interno (Saca Red) -->
      <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-[#EB3333]/5 dark:bg-[#EB3333]/10 blur-[120px] rounded-full pointer-events-none group-hover:bg-[#EB3333]/10 dark:group-hover:bg-[#EB3333]/15 transition-all duration-1000"></div>
      
      {/* Sección Izquierda: Logo Saca Inmaculado (Apple Style) */}
      <div class="flex items-center relative z-10 w-full sm:w-auto justify-center sm:justify-start">
        <div class="relative flex items-center gap-3">
          <!-- Saca Logo Oficial -->
          <img src="/logos/Logo rojo (solo icono).svg" alt="Saca Logo" class="w-8 h-8 relative z-10 dark:hidden block opacity-100 group-hover:scale-105 transition-transform duration-500" />
          <img src="/logos/Logo blanco (solo icono).svg" alt="Saca Logo" class="w-8 h-8 relative z-10 hidden dark:block group-hover:scale-105 transition-transform duration-500" />
          <h1 class="text-[22px] font-semibold text-zinc-900 dark:text-white m-0 tracking-tight transition-colors hidden sm:block">Saca Network</h1>
        </div>
      </div>
      
      {/* Sección Derecha: Utilidades & Perfil */}
      <div class="flex items-center gap-4 sm:gap-6 relative z-10 w-full sm:w-auto justify-between sm:justify-end">
        <div class="flex flex-col sm:items-end">
          <p class="text-[13px] font-medium text-zinc-500 dark:text-zinc-400 m-0 tracking-wide bg-black/5 dark:bg-white/5 px-3 py-1 rounded-full border border-black/5 dark:border-white/5">{user?.email}</p>
        </div>
        
        <div class="w-px h-8 bg-zinc-200 dark:bg-white/10 hidden sm:block"></div>

        <button 
          id="logout-btn" 
          class="text-[13px] px-5 py-2 rounded-full bg-transparent hover:bg-black/5 dark:hover:bg-white/5 border border-transparent text-zinc-600 hover:text-[#EB3333] dark:text-zinc-300 dark:hover:text-white transition-all duration-300 relative z-10 font-medium active:scale-95 flex items-center gap-2 group/logout"
        >
          Cerrar sesión
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="opacity-50 group-hover/logout:opacity-100 group-hover/logout:translate-x-1 transition-all"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        </button>
      </div>
    </header>

    <DashboardApp client:only="react" initialLinks={initialLinks || []} />
  </main>
</Layout>

<script>
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    // Feedback táctil visual antes de salir
    document.getElementById('logout-btn')!.style.opacity = '0.5';
    
    await fetch('/api/auth/set-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ event: 'SIGNED_OUT', session: null }),
    });
    window.location.href = '/login';
  });
</script>
