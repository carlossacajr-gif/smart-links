---
import Layout from '../layouts/Layout.astro';
import DashboardApp from '../components/DashboardApp';

// Protegido por el middleware. Si llegamos aquí, tenemos sesión válida en supabase.
const { cookies } = Astro;
const accessToken = cookies.get("sb-access-token")?.value;
const refreshToken = cookies.get("sb-refresh-token")?.value;

// Asegurarse de tener la sesión para el render inicial inyectada
import { supabase } from '../lib/supabase';
await supabase.auth.setSession({
  access_token: accessToken || '',
  refresh_token: refreshToken || ''
});

const { data: { user } } = await supabase.auth.getUser();

// Obtener links iniciales por SSR para hidratar React
const { data: initialLinks } = await supabase
  .from('links')
  .select('*, clicks(count)')
  .order('created_at', { ascending: false });

---

<Layout title="Dashboard">
  <main className="min-h-screen p-4 md:p-8 max-w-6xl mx-auto flex flex-col gap-8">
    <header className="flex justify-between items-center bg-[#121214]/80 backdrop-blur-xl border border-[#27272A] rounded-2xl p-4 md:px-6 shadow-xl relative overflow-hidden">
      <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 blur-[100px] rounded-full pointer-events-none"></div>
      
      <div className="flex items-center gap-3 relative z-10">
        <div className="w-10 h-10 rounded-xl bg-indigo-500/10 border border-indigo-500/20 flex flex-col justify-center items-center">
            <div className="w-2.5 h-2.5 rounded-full bg-indigo-500 animate-pulse shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div>
        </div>
        <div>
          <h1 className="text-xl font-bold tracking-tight text-white m-0 leading-tight">Smart Links</h1>
          <p className="text-xs text-zinc-400 m-0">Bienvenido, {user?.email}</p>
        </div>
      </div>
      
      <button 
        id="logout-btn" 
        class="text-sm px-4 py-2 rounded-xl bg-zinc-800/50 hover:bg-zinc-800 border border-zinc-700/50 text-zinc-300 transition-colors relative z-10 font-medium"
      >
        Cerrar Sesión
      </button>
    </header>

    <DashboardApp client:load initialLinks={initialLinks || []} />
  </main>
</Layout>

<script>
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await fetch('/api/auth/set-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ event: 'SIGNED_OUT', session: null }),
    });
    window.location.href = '/login';
  });
</script>
